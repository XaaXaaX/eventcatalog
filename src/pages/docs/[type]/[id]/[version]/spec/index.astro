---
import type { CollectionEntry } from 'astro:content';
import * as path from 'path';
import fs from 'node:fs';
import { getEvents } from '@utils/events';
import { getServices } from '@utils/services/services';
import { getCommands } from '@utils/commands';
import { getDomains } from '@utils/domains/domains';
import type { CollectionTypes } from '@types';
import PlainPage from '@layouts/PlainPage.astro';
import { DocumentMinusIcon } from '@heroicons/react/24/outline';
import { buildUrl } from '@utils/url-builder';

export async function getStaticPaths() {
  const events = await getEvents();
  const commands = await getCommands();
  const services = await getServices();
  const domains = await getDomains();

  const hasOpenAPISpec = (item: CollectionEntry<CollectionTypes>) => item.data.specifications?.openapiPath !== undefined;

  const buildPages = (collection: CollectionEntry<CollectionTypes>[]) => {
    const filteredCollection = collection.filter(hasOpenAPISpec);

    return filteredCollection.map((item) => ({
      params: {
        type: item.collection,
        id: item.data.id,
        version: item.data.version,
      },
      props: {
        type: item.collection,
        ...item,
      },
    }));
  };

  return [...buildPages(domains), ...buildPages(events), ...buildPages(services), ...buildPages(commands)];
}

// @ts-ignore
const { data, catalog } = Astro.props;
const fileName = data.specifications?.openapiPath || 'openapi.yml';
const pathToSpec = path.join(catalog.publicPath, fileName);
const pathOnDisk = path.join(process.cwd(), 'public', pathToSpec);
const fileExists = fs.existsSync(pathOnDisk);
---

<PlainPage title="OpenAPI Spec">
  {
    !fileExists ? (
      <div class="text-center h-screen  flex flex-col justify-center ">
        <DocumentMinusIcon className="mx-auto h-12 w-12 text-gray-400" />
        <h3 class="mt-2 text-sm font-semibold text-gray-900">No OpenAPI spec file found</h3>
        <p class="mt-1 text-xs text-gray-400">
          Could not find OpenAPI file for {data.name} in {`/${catalog.path}`}
        </p>
      </div>
    ) : (
      <div id="swagger-ui" class="md:pr-14" />
    )
  }
</PlainPage>
<link rel="stylesheet" href="https://unpkg.com/swagger-ui-dist@5.11.0/swagger-ui.css" />
<script is:inline src="https://unpkg.com/swagger-ui-dist@5.11.0/swagger-ui-bundle.js"></script>
<script is:inline src="https://unpkg.com/swagger-ui-dist@5.11.0/swagger-ui-standalone-preset.js"></script>
<script define:vars={{ url: buildUrl(pathToSpec) }}>
  window.onload = () => {
    window.ui = SwaggerUIBundle({
      urls: [{ url: url, name: 'OpenAPI spec' }],
      dom_id: '#swagger-ui',
      presets: [SwaggerUIBundle.presets.apis, SwaggerUIStandalonePreset],
      layout: 'StandaloneLayout',
    });
  };
</script>
